<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Republic Admin | Owner View</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: sans-serif; background: #222; color: white; margin: 0; padding: 20px; }
        
        /* Navigation Tabs */
        .nav-tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid #444; padding-bottom: 10px; }
        .tab-btn { background: none; border: none; color: #888; font-size: 18px; cursor: pointer; padding: 10px; font-weight: bold; }
        .tab-btn.active { color: #ffcc00; border-bottom: 3px solid #ffcc00; }

        /* Sections */
        .section { display: none; }
        .section.active { display: block; }

        /* Order Cards (Same as before) */
        #orders-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .order-card { background: #333; border: 1px solid #444; border-radius: 8px; padding: 15px; }
        .order-header { display: flex; justify-content: space-between; border-bottom: 1px solid #555; padding-bottom: 10px; margin-bottom: 10px; color: #aaa; }
        .item-row { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .btn-ready { width: 100%; padding: 10px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; background: #ffcc00; }

        /* Menu Manager Styles */
        .menu-table { width: 100%; border-collapse: collapse; background: #333; border-radius: 8px; overflow: hidden; }
        .menu-table th, .menu-table td { padding: 15px; text-align: left; border-bottom: 1px solid #444; }
        .menu-table th { background: #444; color: #ffcc00; }
        .stock-toggle { cursor: pointer; padding: 5px 10px; border-radius: 5px; font-size: 12px; font-weight: bold; }
        .in-stock { background: #25D366; color: white; }
        .out-stock { background: #ff4444; color: white; }
    </style>
</head>
<body>
    <header style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h1 style="color:#ffcc00; margin:0;">â˜• Republic Command Center</h1>
        <div id="clock">...</div>
    </header>

    <div class="nav-tabs">
        <button class="tab-btn active" onclick="switchTab('orders')">Live Orders</button>
        <button class="tab-btn" onclick="switchTab('menu')">Menu Manager</button>
    </div>

    <div id="orders" class="section active">
        <div id="orders-grid">
            <p>Waiting for orders...</p>
        </div>
    </div>

    <div id="menu" class="section">
        <table class="menu-table">
            <thead>
                <tr>
                    <th>Item Name</th>
                    <th>Price (KES)</th>
                    <th>Status</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="menu-list">
                </tbody>
        </table>
    </div>

    <script>
        const PROJECT_URL = "https://uveudhkfncwbllczhbhf.supabase.co";
        const PROJECT_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV2ZXVkaGtmbmN3YmxsY3poYmhmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1NTE5MTksImV4cCI6MjA4MjEyNzkxOX0.30rZbjVgShWxeI5FOD8zGJU-Ho6h6d5s7foEIlQVSZI";
        const db = supabase.createClient(PROJECT_URL, PROJECT_KEY);

        // --- TABS LOGIC ---
        function switchTab(tabName) {
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            if(tabName === 'menu') loadMenuEditor();
        }

        // --- ORDER LOGIC ---
        async function loadOrders() {
            const { data } = await db.from('orders').select('*').neq('status', 'completed').order('created_at', { ascending: false });
            if (data) renderOrders(data);
        }

        function renderOrders(orders) {
            const grid = document.getElementById('orders-grid');
            grid.innerHTML = "";
            orders.forEach(order => {
                const card = document.createElement('div');
                card.className = 'order-card';
                card.innerHTML = `
                    <div class="order-header"><span>#${order.id}</span><span>${new Date(order.created_at).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span></div>
                    ${order.items.map(i => `<div class="item-row"><span>${i.name}</span></div>`).join('')}
                    <div style="margin:10px 0; color:#888;">Cust: ${order.customer_phone}</div>
                    <button class="btn-ready" onclick="completeOrder(${order.id})">MARK DONE</button>
                `;
                grid.appendChild(card);
            });
        }

        async function completeOrder(id) {
            if(confirm('Order picked up?')) {
                await db.from('orders').update({ status: 'completed' }).eq('id', id);
                loadOrders(); // Refresh list
            }
        }

        // --- MENU MANAGER LOGIC ---
        async function loadMenuEditor() {
            const tbody = document.getElementById('menu-list');
            tbody.innerHTML = "<tr><td colspan='4'>Loading...</td></tr>";
            
            const { data } = await db.from('menu_items').select('*').order('id');
            
            tbody.innerHTML = "";
            data.forEach(item => {
                const row = document.createElement('tr');
                const statusClass = item.is_available ? 'in-stock' : 'out-stock';
                const statusText = item.is_available ? 'In Stock' : 'Sold Out';
                
                row.innerHTML = `
                    <td>${item.name}</td>
                    <td>${item.price}</td>
                    <td><span class="stock-toggle ${statusClass}" onclick="toggleStock(${item.id}, ${item.is_available})">${statusText}</span></td>
                    <td><button onclick="deleteItem(${item.id})" style="color:red; background:none; border:none; cursor:pointer;">X</button></td>
                `;
                tbody.appendChild(row);
            });
        }

        async function toggleStock(id, currentStatus) {
            // Flip the boolean (true -> false)
            await db.from('menu_items').update({ is_available: !currentStatus }).eq('id', id);
            loadMenuEditor(); // Refresh table
        }

        async function deleteItem(id) {
            if(confirm('Delete this item completely?')) {
                await db.from('menu_items').delete().eq('id', id);
                loadMenuEditor();
            }
        }

        // --- REALTIME LISTENER ---
        db.channel('orders-room').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'orders' }, () => {
            alert("ðŸ”” New Order!");
            loadOrders();
        }).subscribe();

        // Start
        loadOrders();
        setInterval(() => document.getElementById('clock').innerText = new Date().toLocaleTimeString(), 1000);
    </script>
</body>
</html>