<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Executive Dashboard | Republic Express</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        /* --- THEME VARIABLES --- */
        :root { --primary: #3e2723; --accent: #ffcc00; --bg: #f4f6f9; --text: #2c3e50; --card-bg: #fff; --border: #e1e4e8; --sidebar-bg: #fff; --hover: #fdfaf7; }
        body.dark-mode { --bg: #1a1a1a; --text: #f4f4f4; --card-bg: #2d2d2d; --border: #444; --sidebar-bg: #222; --hover: #333; }
        
        * { box-sizing: border-box; } 

        body { 
            font-family: 'Segoe UI', sans-serif; 
            background: var(--bg); 
            color: var(--text); 
            margin: 0; 
            display: flex; 
            height: 100vh; 
            overflow: hidden; 
            transition: background 0.3s; 
        }

        /* --- SIDEBAR --- */
        .sidebar { width: 260px; background: var(--sidebar-bg); border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 25px; z-index: 100; transition: transform 0.3s ease; flex-shrink: 0; }
        .brand { font-size: 20px; font-weight: 800; color: var(--primary); margin-bottom: 40px; display: flex; justify-content: space-between; align-items: center; }
        .close-sidebar-btn { display: none; background: none; border: none; font-size: 24px; color: var(--text); cursor: pointer; }

        .nav-item { padding: 12px 15px; margin-bottom: 5px; border-radius: 8px; cursor: pointer; color: #888; font-weight: 500; display: flex; align-items: center; gap: 10px; }
        .nav-item:hover { background: var(--hover); color: var(--primary); }
        .nav-item.active { background: var(--primary); color: var(--accent); font-weight: bold; }
        .theme-switch { margin-top: auto; margin-bottom: 10px; padding: 12px 15px; cursor: pointer; color: #888; display: flex; align-items: center; gap: 10px; font-weight: 500; }

        /* --- MAIN CONTENT --- */
        .main { flex: 1; padding: 30px; overflow-y: auto; height: 100%; position: relative; }
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-wrap: wrap; gap: 15px; }
        .hamburger-btn { display: none; background: none; border: none; font-size: 28px; cursor: pointer; color: var(--text); margin-right: 15px; }
        .header-title-group { display: flex; align-items: center; }
        .controls-row { display: flex; gap: 10px; align-items: center; }

        /* --- GRID SYSTEM --- */
        .grid-kpi { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
        .grid-charts { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .grid-ops { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        
        /* CARD (Updated for PDF Page Breaks) */
        .card { 
            background: var(--card-bg); 
            border-radius: 12px; 
            padding: 20px; 
            border: 1px solid var(--border); 
            box-shadow: 0 2px 10px rgba(0,0,0,0.02); 
            margin-bottom: 20px;
            /* These lines prevent the PDF from cutting cards in half */
            break-inside: avoid;
            page-break-inside: avoid; 
        }
        
        .chart-box { position: relative; height: 300px; width: 100%; }

        .kpi-title { font-size: 13px; color: #888; text-transform: uppercase; font-weight: 700; }
        .kpi-value { font-size: 28px; font-weight: 800; color: var(--primary); margin-top: 5px; }

        /* --- MENU & FEEDBACK --- */
        .menu-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; }
        .menu-item-card { background: var(--card-bg); border: 1px solid var(--border); border-radius: 10px; overflow: hidden; position: relative; break-inside: avoid; page-break-inside: avoid; }
        .menu-img { width: 100%; height: 140px; object-fit: cover; }
        .sale-badge { position: absolute; top: 10px; left: 10px; background: #ff4444; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; }

        .review-item { border-bottom: 1px solid var(--border); padding: 15px 0; }
        .stars { color: #ffcc00; font-size: 18px; letter-spacing: 2px; }
        .review-comment { font-style: italic; color: #555; margin-top: 5px; }

        /* --- UI ELEMENTS --- */
        .btn { padding: 10px 20px; border-radius: 6px; border: none; font-weight: 600; cursor: pointer; background: var(--primary); color: white; }
        .filter-group { background: var(--card-bg); padding: 5px; border-radius: 8px; border: 1px solid var(--border); display: flex; gap: 5px; }
        .filter-btn { padding: 8px 15px; border: none; background: none; cursor: pointer; border-radius: 6px; font-weight: 600; color: #888; font-size: 13px; }
        .filter-btn.active { background: var(--primary); color: white; }
        
        table { width: 100%; border-collapse: collapse; color: var(--text); }
        th, td { text-align: left; padding: 12px 5px; border-bottom: 1px solid var(--border); font-size: 14px; }
        
        /* --- MODAL --- */
        #editor-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 200; align-items: center; justify-content: center; }
        .modal-content { background: var(--card-bg); padding: 25px; border-radius: 12px; width: 500px; max-width: 90%; max-height: 90vh; overflow-y: auto; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid var(--border); background: var(--bg); color: var(--text); border-radius: 5px; margin-bottom: 10px; box-sizing: border-box; }
        
        .addon-group { border: 1px solid var(--border); padding: 10px; border-radius: 8px; margin-bottom: 10px; }
        .addon-row { display: flex; gap: 5px; margin-bottom: 5px; }
        .sm-btn { padding: 5px 10px; border-radius: 4px; border: 1px solid var(--border); cursor: pointer; }
        
        .section { display: none; } .section.active { display: block; }
        
        /* --- MOBILE RESPONSIVENESS --- */
        @media (max-width: 768px) {
            .sidebar { position: fixed; left: 0; top: 0; bottom: 0; width: 260px; transform: translateX(-100%); box-shadow: 5px 0 15px rgba(0,0,0,0.3); }
            .sidebar.open { transform: translateX(0); }
            .hamburger-btn { display: block; } .close-sidebar-btn { display: block; }
            .main { padding: 15px; }
            .grid-kpi { grid-template-columns: 1fr; }
            .grid-charts, .grid-ops { grid-template-columns: 1fr; }
            .chart-box { height: 250px; }
        }
    </style>
</head>
<body>

    <div class="sidebar" id="sidebar" data-html2canvas-ignore="true">
        <div class="brand">
            <span>‚òï Republic<span style="color:var(--accent)">Admin</span></span>
            <button class="close-sidebar-btn" onclick="toggleSidebar()">√ó</button>
        </div>
        <div class="nav-item active" onclick="nav('dashboard', this); toggleSidebar(false)">üìä Analytics</div>
        <div class="nav-item" onclick="nav('menu', this); toggleSidebar(false)">üçî Menu</div>
        <div class="nav-item" onclick="nav('feedback', this); toggleSidebar(false)">‚≠ê Feedback</div>
        <div class="nav-item" onclick="nav('staff', this); toggleSidebar(false)">üë• Staff</div>
        <div class="nav-item" onclick="nav('settings', this); toggleSidebar(false)">‚öôÔ∏è Settings</div>
        
        <div class="theme-switch" onclick="toggleTheme()">
            <span id="theme-icon">üåô</span> <span id="theme-text">Dark Mode</span>
        </div>
        <div class="nav-item" onclick="logout()" style="color:#dc2626;">üö™ Logout</div>
    </div>

    <div class="main" id="report-area">
        
        <div id="dashboard" class="section active">
            <div class="page-header">
                <div class="header-title-group">
                    <button class="hamburger-btn" onclick="toggleSidebar()">‚ò∞</button>
                    <div><h1 style="margin:0; font-size:24px;">Overview</h1><p style="margin:0; color:#888; font-size:12px;" id="period-label">Today</p></div>
                </div>
                <div class="controls-row" data-html2canvas-ignore="true">
                    <div class="filter-group">
                        <button class="filter-btn active" onclick="setFilter('today', this)">Today</button>
                        <button class="filter-btn" onclick="setFilter('month', this)">Month</button>
                        <button class="filter-btn" onclick="setFilter('year', this)">Year</button>
                    </div>
                    <button class="btn" style="padding: 8px 12px; font-size:12px;" onclick="exportPDF()">üìÑ PDF</button>
                </div>
            </div>

            <div class="grid-kpi">
                <div class="card"><div class="kpi-title">Revenue</div><div class="kpi-value" id="kpi-revenue">...</div></div>
                <div class="card"><div class="kpi-title">Orders</div><div class="kpi-value" id="kpi-orders">...</div></div>
                <div class="card"><div class="kpi-title">Avg Rating</div><div class="kpi-value" id="kpi-rating">...</div></div>
                <div class="card"><div class="kpi-title">Low Stock</div><div class="kpi-value" id="kpi-stock" style="color:#d35400">...</div></div>
            </div>

            <div class="grid-charts">
                <div class="card"><span class="kpi-title">Revenue Trend</span><div class="chart-box"><canvas id="revenueChart"></canvas></div></div>
                <div class="card"><span class="kpi-title">Top Sellers</span><div class="chart-box"><canvas id="productChart"></canvas></div></div>
            </div>

            <div class="grid-ops">
                <div class="card">
                    <div style="display:flex; justify-content:space-between; margin-bottom:15px;"><span class="kpi-title" style="color:#d35400;">üî• Active Orders</span><span id="active-count" style="background:#d35400; color:white; padding:2px 8px; border-radius:10px; font-size:12px; font-weight:bold;">0</span></div>
                    <div id="active-orders-list"></div>
                </div>
                <div class="card">
                    <div style="display:flex; justify-content:space-between; margin-bottom:15px;"><span class="kpi-title" style="color:#2980b9;">üë• Staff Overview</span><span id="staff-count" style="background:#2980b9; color:white; padding:2px 8px; border-radius:10px; font-size:12px; font-weight:bold;">0</span></div>
                    <table style="width:100%"><tbody id="mini-staff-table"></tbody></table>
                </div>
            </div>
        </div>

        <div id="menu" class="section">
            <div class="page-header">
                <div class="header-title-group">
                      <button class="hamburger-btn" onclick="toggleSidebar()">‚ò∞</button>
                      <h1 style="margin:0; font-size:24px;">Menu</h1>
                </div>
                <button class="btn" onclick="openEditor()">+ Add</button>
            </div>
            <div class="menu-grid" id="menu-grid"></div>
        </div>

        <div id="feedback" class="section">
            <div class="page-header">
                <div class="header-title-group">
                    <button class="hamburger-btn" onclick="toggleSidebar()">‚ò∞</button>
                    <h1 style="margin:0; font-size:24px;">Customer Feedback</h1>
                </div>
            </div>
            <div class="card">
                <div id="reviews-list">Loading reviews...</div>
            </div>
        </div>

        <div id="staff" class="section">
             <div class="page-header"><div class="header-title-group"><button class="hamburger-btn" onclick="toggleSidebar()">‚ò∞</button><h1>Staff Intelligence</h1></div></div>
             
             <div class="grid-charts">
                 <div class="card">
                     <h3>Detailed Metrics</h3>
                     <table style="width:100%">
                         <thead><tr><th>Staff Name</th><th>Orders</th><th>Revenue</th><th>Avg Rating</th></tr></thead>
                         <tbody id="staff-analytics-table"><tr><td>Loading...</td></tr></tbody>
                     </table>
                 </div>
                 
                 <div class="card">
                     <h3>Manage Accounts</h3>
                     <div style="display:flex; gap:5px; margin-bottom:10px;">
                         <input id="new-user" placeholder="Username">
                         <input id="new-pass" placeholder="Password">
                         <select id="new-role"><option value="barista">Barista</option><option value="owner">Owner</option></select>
                     </div>
                     <button class="btn" style="width:100%; margin-bottom:20px;" onclick="addStaff()">+ Add User</button>
                     <table style="width:100%"><tbody id="full-staff-table"></tbody></table>
                 </div>
             </div>

             <div class="card" style="margin-top:20px;">
                 <h3>üèÜ Top Performers (Orders Handled)</h3>
                 <div class="chart-box"><canvas id="staffPerfChart"></canvas></div>
             </div>
        </div>

        <div id="settings" class="section">
             <div class="page-header"><div class="header-title-group"><button class="hamburger-btn" onclick="toggleSidebar()">‚ò∞</button><h1>Settings</h1></div></div>
             <div class="card"><h3>Security</h3><input type="password" id="update-pass" placeholder="New Password"><button class="btn" onclick="updateMyPassword()">Update</button></div>
        </div>

    </div>

    <div id="editor-modal">
        <div class="modal-content">
            <h2 id="modal-title" style="margin-top:0;">Edit Item</h2>
            <input type="hidden" id="edit-id">
            
            <label>Name</label><input type="text" id="edit-name">
            <div style="display:flex; gap:10px;">
                <div style="flex:1"><label>Price</label><input type="number" id="edit-price"></div>
                <div style="flex:1"><label>Category</label><select id="edit-category"><option>Hot Coffee</option><option>Iced Coffee</option><option>Tea</option><option>Snacks</option><option>Meals</option></select></div>
            </div>
            
            <label>Original Price (For Sale Badge)</label><input type="number" id="edit-original">
            <label>Description</label><textarea id="edit-desc" rows="2"></textarea>
            
            <label>Stock Quantity (Inventory)</label>
            <input type="number" id="edit-stock" placeholder="e.g. 50">
            
            <label>Inventory Note</label>
            <textarea id="inventory-note" rows="2" placeholder="e.g. 'Fresh batch arrived at 8am'"></textarea>

            <div style="margin-top:10px; border-top:1px solid #eee; padding-top:10px;">
                <label>Add-ons</label>
                <div id="addons-container"></div>
                <button class="sm-btn" style="width:100%; margin-top:5px;" onclick="addAddonGroup()">+ Add Group</button>
            </div>
            
            <label style="margin-top:15px;">Image</label><input type="file" id="edit-image" accept="image/*">
            
            <div style="margin-top:20px; display:flex; gap:10px;">
                <button class="btn" onclick="saveItem()">Save</button>
                <button class="btn" style="background:#888" onclick="closeEditor()">Cancel</button>
            </div>
            <button class="btn btn-danger" id="delete-btn" style="width:100%; margin-top:10px;" onclick="deleteItem()">Delete</button>
        </div>
    </div>

    <script>
        const PROJECT_URL = "https://uveudhkfncwbllczhbhf.supabase.co";
        const PROJECT_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV2ZXVkaGtmbmN3YmxsY3poYmhmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1NTE5MTksImV4cCI6MjA4MjEyNzkxOX0.30rZbjVgShWxeI5FOD8zGJU-Ho6h6d5s7foEIlQVSZI";
        const db = supabase.createClient(PROJECT_URL, PROJECT_KEY);
        let allOrders = [], revenueChartInst = null, productChartInst = null, staffChartInst = null, currentFilter = 'today', currentAddons = [];
        
        const user = JSON.parse(localStorage.getItem('republic_user'));
        if (!user || user.role !== 'owner') window.location.href = 'login.html';
        
        init();

        function toggleSidebar(forceOpen) { const el = document.getElementById('sidebar'); if (forceOpen === false) el.classList.remove('open'); else el.classList.toggle('open'); }
        function toggleTheme() { document.body.classList.toggle('dark-mode'); const isDark = document.body.classList.contains('dark-mode'); localStorage.setItem('owner_theme', isDark ? 'dark' : 'light'); document.getElementById('theme-icon').innerText = isDark ? "‚òÄÔ∏è" : "üåô"; if(document.getElementById('dashboard').classList.contains('active')) renderCharts(allOrders); }
        if (localStorage.getItem('owner_theme') === 'dark') { document.body.classList.add('dark-mode'); document.getElementById('theme-icon').innerText = "‚òÄÔ∏è"; }

        async function init() {
            const { data: paid } = await db.from('orders').select('*').eq('payment_status', 'paid').order('created_at', {ascending: true});
            if(paid) { allOrders = paid; setFilter('today', document.querySelector('.filter-btn.active')); }
            loadActiveOrders(); loadStaffList(); loadMenuGrid(); loadReviews(); loadStockAlert(); loadStaffAnalytics();
        }

        function nav(id, el) { document.querySelectorAll('.section').forEach(s => s.classList.remove('active')); document.getElementById(id).classList.add('active'); document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active')); el.classList.add('active'); }
        function setFilter(period, btn) { 
            currentFilter = period; 
            if(btn) { document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); } 
            const now = new Date(); 
            let filtered = []; 
            if (period === 'today') filtered = allOrders.filter(o => o.created_at.startsWith(now.toISOString().split('T')[0])); 
            else if (period === 'month') filtered = allOrders.filter(o => o.created_at.startsWith(now.toISOString().slice(0, 7))); 
            else if (period === 'year') filtered = allOrders.filter(o => o.created_at.startsWith(now.toISOString().slice(0, 4))); 
            else filtered = allOrders; 
            document.getElementById('period-label').innerText = period.charAt(0).toUpperCase() + period.slice(1); 
            updateDashboard(filtered); 
        }

        function updateDashboard(orders) {
            const revenue = orders.reduce((sum, o) => sum + o.total_price, 0);
            const count = orders.length;
            
            const revEl = document.getElementById('kpi-revenue'); if(revEl) revEl.innerText = "KES " + revenue.toLocaleString();
            const orderEl = document.getElementById('kpi-orders'); if(orderEl) orderEl.innerText = count;
            const aiEl = document.getElementById('ai-insight-text'); if(aiEl) aiEl.innerText = count > 0 ? `üöÄ Rev: KES ${revenue.toLocaleString()} (${count} Orders)` : "No data.";
            
            renderCharts(orders);
        }

        function renderCharts(orders) {
            const isDark = document.body.classList.contains('dark-mode'); const textColor = isDark ? '#ccc' : '#666'; const dataMap = {};
            orders.forEach(o => { const key = currentFilter === 'today' ? new Date(o.created_at).getHours()+":00" : new Date(o.created_at).toLocaleDateString(); dataMap[key] = (dataMap[key] || 0) + o.total_price; });
            const ctx1 = document.getElementById('revenueChart').getContext('2d'); if(revenueChartInst) revenueChartInst.destroy(); revenueChartInst = new Chart(ctx1, { type: 'line', data: { labels: Object.keys(dataMap), datasets: [{ label: 'Sales', data: Object.values(dataMap), borderColor: '#3e2723', backgroundColor: 'rgba(62,39,35,0.1)', fill: true }] }, options: { responsive:true, maintainAspectRatio: false, plugins:{legend:{display:false}}, scales:{x:{ticks:{color:textColor}}, y:{ticks:{color:textColor}}} } });
            const prodMap = {}; orders.forEach(o => o.items.forEach(i => prodMap[i.name] = (prodMap[i.name]||0)+1)); const top = Object.entries(prodMap).sort((a,b)=>b[1]-a[1]).slice(0,5);
            const ctx2 = document.getElementById('productChart').getContext('2d'); if(productChartInst) productChartInst.destroy(); productChartInst = new Chart(ctx2, { type: 'doughnut', data: { labels: top.map(x=>x[0]), datasets: [{ data: top.map(x=>x[1]), backgroundColor: ['#3e2723','#5d4037','#795548','#8d6e63','#a1887f'] }] }, options: { responsive:true, maintainAspectRatio: false, plugins:{legend:{position:'right', labels:{color:textColor}}} } });
        }

        /* --- STAFF LIST --- */
        async function loadStaffList() { 
            const { data } = await db.from('users').select('*'); 
            
            // 1. Update Management Table (In Staff Tab)
            const manageTable = document.getElementById('full-staff-table');
            if(manageTable) {
                manageTable.innerHTML = data.map(u => `<tr><td>${u.username}</td><td>${u.role}</td><td><button class="sm-btn" onclick="delStaff(${u.id})">Del</button></td></tr>`).join('');
            }

            // 2. Update Mini List (In Dashboard Tab)
            const miniTable = document.getElementById('mini-staff-table');
            if(miniTable) {
                miniTable.innerHTML = data.map(u => `<tr><td>${u.username}</td><td><span style="font-size:11px; padding:2px 6px; background:#eee; border-radius:4px;">${u.role}</span></td></tr>`).join('');
            }

            // 3. Update Overview Counter
            const countEl = document.getElementById('staff-count');
            if(countEl) countEl.innerText = data.length;
        }

        async function loadStaffAnalytics() {
            const { data: orders } = await db.from('orders').select('*').eq('payment_status', 'paid');
            const { data: reviews } = await db.from('reviews').select('*');
            if(!orders) return;

            const stats = {}; 
            orders.forEach(o => {
                const staff = o.handled_by || 'Unknown';
                if(!stats[staff]) stats[staff] = { orders: 0, revenue: 0, ratings: [] };
                stats[staff].orders += 1;
                stats[staff].revenue += o.total_price;
                const rev = reviews ? reviews.find(r => r.order_id === o.id) : null;
                if(rev) stats[staff].ratings.push(rev.rating);
            });

            const tbody = document.getElementById('staff-analytics-table');
            if(tbody) {
                tbody.innerHTML = "";
                const labels = []; const dataPoints = [];
                Object.keys(stats).forEach(name => {
                    const s = stats[name];
                    const avgRating = s.ratings.length > 0 ? (s.ratings.reduce((a,b)=>a+b,0)/s.ratings.length).toFixed(1) : '-';
                    tbody.innerHTML += `<tr><td><b>${name}</b></td><td>${s.orders}</td><td>KES ${s.revenue.toLocaleString()}</td><td>${avgRating} ‚≠ê</td></tr>`;
                    labels.push(name); dataPoints.push(s.orders);
                });

                const ctx = document.getElementById('staffPerfChart').getContext('2d');
                if(staffChartInst) staffChartInst.destroy();
                const isDark = document.body.classList.contains('dark-mode'); 
                const textColor = isDark ? '#ccc' : '#666';
                staffChartInst = new Chart(ctx, { type: 'bar', data: { labels: labels, datasets: [{ label: 'Orders Handled', data: dataPoints, backgroundColor: '#ffcc00' }] }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { ticks: { color: textColor } }, y: { ticks: { color: textColor } } }, plugins: { legend: { display: false } } } });
            }
        }

        /* --- REVIEWS & STOCK --- */
        async function loadReviews() {
            const { data } = await db.from('reviews').select('*').order('created_at', {ascending: false});
            const list = document.getElementById('reviews-list');
            if(data && data.length > 0) {
                const avg = (data.reduce((sum, r) => sum + r.rating, 0) / data.length).toFixed(1);
                const rateEl = document.getElementById('kpi-rating'); if(rateEl) rateEl.innerText = `${avg} ‚≠ê`;
                if(list) {
                    list.innerHTML = "";
                    data.forEach(r => {
                        const stars = "‚òÖ".repeat(r.rating) + "‚òÜ".repeat(5-r.rating);
                        list.innerHTML += `<div class="review-item"><div style="display:flex; justify-content:space-between;"><span class="stars">${stars}</span><span style="font-size:12px; color:#888;">${new Date(r.created_at).toLocaleDateString()}</span></div><div class="review-comment">"${r.comment || 'No comment'}"</div></div>`;
                    });
                }
            } else { 
                const rateEl = document.getElementById('kpi-rating'); if(rateEl) rateEl.innerText = "-"; 
                if(list) list.innerHTML = "<p>No reviews yet.</p>"; 
            }
        }

        async function loadStockAlert() {
            const { data } = await db.from('menu_items').select('*').lt('stock_quantity', 10);
            const stockEl = document.getElementById('kpi-stock');
            if(stockEl) stockEl.innerText = data ? data.length + " Items" : "0 Items";
        }

        /* --- MENU EDITOR --- */
        async function loadMenuGrid() { const { data } = await db.from('menu_items').select('*').order('id'); const grid = document.getElementById('menu-grid'); if(grid) { grid.innerHTML = ""; data.forEach(item => { const img = item.image_url || 'https://via.placeholder.com/300'; const stockBadge = item.stock_quantity < 5 ? `<div style="background:red; color:white; font-size:10px; padding:2px 5px; position:absolute; bottom:5px; right:5px; border-radius:4px;">Low: ${item.stock_quantity}</div>` : `<div style="background:#25D366; color:white; font-size:10px; padding:2px 5px; position:absolute; bottom:5px; right:5px; border-radius:4px;">${item.stock_quantity}</div>`; grid.innerHTML += `<div class="menu-item-card">${stockBadge}<img src="${img}" class="menu-img"><div style="padding:15px;"><b>${item.name}</b><br>KES ${item.price}<button style="width:100%; margin-top:10px; padding:8px; cursor:pointer; border:1px solid #ccc; background:#fff; border-radius:5px;" onclick='openEditor(${JSON.stringify(item)})'>Edit</button></div></div>`; }); } }
        
        function renderAddonEditor() { const container = document.getElementById('addons-container'); container.innerHTML = ""; currentAddons.forEach((group, gIndex) => { const optionsHtml = group.options.map((opt, oIndex) => `<div class="addon-row"><input type="text" placeholder="Opt Name" value="${opt.name}" onchange="updateOption(${gIndex}, ${oIndex}, 'name', this.value)" style="flex:2; margin:0;"><input type="number" placeholder="Price" value="${opt.price}" onchange="updateOption(${gIndex}, ${oIndex}, 'price', this.value)" style="flex:1; margin:0;"><button class="sm-btn remove-btn" onclick="removeOption(${gIndex}, ${oIndex})">X</button></div>`).join(''); container.innerHTML += `<div class="addon-group"><div class="addon-header"><input type="text" value="${group.name}" placeholder="Group Name" onchange="updateGroup(${gIndex}, this.value)" style="margin:0; width:60%; font-weight:bold;"><button class="sm-btn" onclick="removeGroup(${gIndex})" style="color:red; border-color:red;">Del</button></div><div style="margin-top:5px;">${optionsHtml}</div><button class="sm-btn" style="margin-top:5px;" onclick="addOptionToGroup(${gIndex})">+ Opt</button></div>`; }); }
        window.addAddonGroup = () => { currentAddons.push({ name: "", options: [] }); renderAddonEditor(); }; window.removeGroup = (i) => { currentAddons.splice(i, 1); renderAddonEditor(); }; window.updateGroup = (i, val) => { currentAddons[i].name = val; }; window.addOptionToGroup = (i) => { currentAddons[i].options.push({ name: "", price: 0 }); renderAddonEditor(); }; window.removeOption = (gI, oI) => { currentAddons[gI].options.splice(oI, 1); renderAddonEditor(); }; window.updateOption = (gI, oI, field, val) => { currentAddons[gI].options[oI][field] = field==='price' ? Number(val) : val; };
        
        window.openEditor = (item = null) => { 
            document.getElementById('editor-modal').style.display = 'flex'; 
            if (item) { 
                document.getElementById('edit-id').value = item.id; 
                document.getElementById('edit-name').value = item.name; 
                document.getElementById('edit-price').value = item.price; 
                document.getElementById('edit-category').value = item.category; 
                document.getElementById('edit-original').value = item.original_price; 
                document.getElementById('edit-desc').value = item.description; 
                document.getElementById('edit-stock').value = item.stock_quantity; 
                if(document.getElementById('inventory-note')) document.getElementById('inventory-note').value = item.inventory_note || "";
                document.getElementById('delete-btn').style.display = 'block'; 
                currentAddons = item.addons || []; 
            } else { 
                document.getElementById('edit-id').value = ""; 
                document.getElementById('edit-name').value = ""; 
                document.getElementById('edit-price').value = ""; 
                document.getElementById('edit-stock').value = "100"; 
                if(document.getElementById('inventory-note')) document.getElementById('inventory-note').value = "";
                document.getElementById('delete-btn').style.display = 'none'; 
                currentAddons = []; 
            } 
            renderAddonEditor(); 
        };
        window.closeEditor = () => document.getElementById('editor-modal').style.display = 'none';
        window.saveItem = async () => { 
            const id = document.getElementById('edit-id').value; 
            let updateData = { 
                name: document.getElementById('edit-name').value, 
                price: document.getElementById('edit-price').value, 
                category: document.getElementById('edit-category').value, 
                original_price: document.getElementById('edit-original').value || 0, 
                description: document.getElementById('edit-desc').value, 
                stock_quantity: parseInt(document.getElementById('edit-stock').value) || 0, 
                inventory_note: document.getElementById('inventory-note') ? document.getElementById('inventory-note').value : "",
                addons: currentAddons, 
                is_available: true 
            }; 
            const fileInput = document.getElementById('edit-image'); 
            if (fileInput.files.length > 0) { 
                const fileName = `img_${Date.now()}`; 
                await db.storage.from('menu_photos').upload(fileName, fileInput.files[0]); 
                const { data: urlData } = db.storage.from('menu_photos').getPublicUrl(fileName); 
                updateData.image_url = urlData.publicUrl; 
            } 
            if(id) await db.from('menu_items').update(updateData).eq('id', id); else await db.from('menu_items').insert([updateData]); 
            closeEditor(); loadMenuGrid(); loadStockAlert(); 
        };
        window.deleteItem = async () => { if(confirm("Delete?")) { await db.from('menu_items').delete().eq('id', document.getElementById('edit-id').value); closeEditor(); loadMenuGrid(); } };
        async function loadActiveOrders() { const { data } = await db.from('orders').select('*').neq('status', 'completed').order('created_at', {ascending: false}); const list = document.getElementById('active-orders-list'); if(list) { list.innerHTML = data.map(o => `<div style="padding:10px; border-bottom:1px solid #eee; display:flex; justify-content:space-between;"><span>#${o.id}</span><span class="status-badge badge-${o.status}">${o.status}</span></div>`).join(''); } const countEl = document.getElementById('active-count'); if(countEl) countEl.innerText = data.length; }
        
        async function addStaff() { const u=document.getElementById('new-user').value, p=document.getElementById('new-pass').value, r=document.getElementById('new-role').value; if(u&&p){ await db.from('users').insert([{username:u, password:p, role:r}]); loadStaffList(); } }
        async function delStaff(id) { if(confirm("Remove?")) { await db.from('users').delete().eq('id', id); loadStaffList(); } }
        async function updateMyPassword() { const p = document.getElementById('update-pass').value; if(p){ await db.from('users').update({password:p}).eq('id', user.id); alert("Updated"); logout(); } }
        
        // --- EXPORT PDF (FIXED CONFIG) ---
        function exportPDF() { 
            const element = document.querySelector('.section.active'); 
            const btn = document.querySelector('button[onclick="exportPDF()"]');
            btn.innerText = "‚è≥...";
            
            html2pdf().set({ 
                margin: 0.3, 
                filename: `Republic_Report_${new Date().toISOString().split('T')[0]}.pdf`, 
                image: {type:'jpeg',quality:0.98}, 
                html2canvas: {scale:2, useCORS:true}, 
                jsPDF: {unit:'in', format:'letter', orientation:'landscape'},
                pagebreak: { mode: 'avoid-all', avoid: '.card' }
            }).from(element).save().then(() => { btn.innerText = "üìÑ PDF"; }); 
        }
        
        function logout() { localStorage.removeItem('republic_user'); window.location.href='login.html'; }
        
        db.channel('exec-dash').on('postgres_changes', { event: '*', schema: 'public', table: 'orders' }, () => { init(); }).subscribe();
    </script>
</body>
</html>